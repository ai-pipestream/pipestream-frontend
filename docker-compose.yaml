version: "3.8"

# Docker Compose for pipestream-frontend development
# Brings up all backend services needed for frontend testing

services:
  # Service Registry - must start first
  platform-registration-service:
    image: pipestreamai/platform-registration-service:latest
    container_name: platform-registration-service
    ports:
      - "38101:38101"
    environment:
      - QUARKUS_GRPC_SERVER_PORT=38101
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/q/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - pipestream-net

  account-service:
    image: pipestreamai/account-service:latest
    container_name: account-service
    depends_on:
      platform-registration-service:
        condition: service_healthy
    environment:
      - PLATFORM_REGISTRATION_HOST=platform-registration-service
      - PLATFORM_REGISTRATION_PORT=38101
    networks:
      - pipestream-net

  connector-admin:
    image: pipestreamai/connector-admin:latest
    container_name: connector-admin
    depends_on:
      platform-registration-service:
        condition: service_healthy
    environment:
      - PLATFORM_REGISTRATION_HOST=platform-registration-service
      - PLATFORM_REGISTRATION_PORT=38101
    networks:
      - pipestream-net

  connector-intake-service:
    image: pipestreamai/connector-intake-service:latest
    container_name: connector-intake-service
    depends_on:
      platform-registration-service:
        condition: service_healthy
    environment:
      - PLATFORM_REGISTRATION_HOST=platform-registration-service
      - PLATFORM_REGISTRATION_PORT=38101
    networks:
      - pipestream-net

  opensearch-manager:
    image: pipestreamai/opensearch-manager:latest
    container_name: opensearch-manager
    depends_on:
      platform-registration-service:
        condition: service_healthy
    environment:
      - PLATFORM_REGISTRATION_HOST=platform-registration-service
      - PLATFORM_REGISTRATION_PORT=38101
    networks:
      - pipestream-net

  # WireMock for mocking services during development (optional)
  # Uncomment if needed for testing without full backend
  # wiremock:
  #   image: pipestreamai/wiremock:latest
  #   container_name: wiremock
  #   ports:
  #     - "8080:8080"
  #   networks:
  #     - pipestream-net

networks:
  pipestream-net:
    driver: bridge
    name: pipestream-net
